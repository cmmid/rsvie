---
title: "Using the RSV Impact Evaluation `rsvie` Package (A)"
author: "Your Name"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using the RSV Impact Evaluation `rsvie` Package (A)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Markdown explaining how to use the RSV impact evaluation `rsvie` package

## 1. Load package and functions
This vignette explains how to use the `rsvie` package to evaluate the impact of different RSV intervention programmes. The package is designed to be flexible and allow the user to define different intervention programmes, with different immunological profiles, and evaluate their impact on RSV outcomes.


```{r, load libraries, echo=FALSE, results='hide'}

# Load the package (or library(rsvie))
devtools::load_all()

# This defines an RSVProgramme class
RSVempty <- make_rsv_programme(1)

# To see what is in these slots 
RSVempty %>% str

```

Let's have a more detailed look at what's in these slots. I wouldn't recommend changing them, but future package iterations should allow for more flexibility. 

```{r check, echo=FALSE, results='hide'}

RSVempty@prog_name # Name of the programme considered (currently empty)
RSVempty@econ_name # Name of the economics considered (currently empty)
RSVempty@uk_data # UK-specific parameters which are used to define the model (RSVempty@model is copied from this)
RSVempty@model # This is the R interface to the cpp class defined in src/RunIntervention.cpp
RSVempty@model_par # This gives the burn-in and run_yrs (how long the model is run for after bur-in). 
RSVempty@econ_par # Parameters associated with the economics of the model, time_horizon is currently set to 10 years, and the discount rate is 3.5%
RSVempty@post # Posterior distributions fitted to UK-specific data
RSVempty@uk_data$populationAgeGroup # Posterior distributions fitted to UK-specific data

```

## 2. Add estimate pre-vaccination burden and risks of the programme

With this empty class, we now add information on the economics of the model. This includes the health outcomes considered, the risk of each health outcome occurring per infection, and the QALY loss and cost of each outcome.
First, we define the risk of each health outcome per age group:

```{r incidence, echo=FALSE, results='hide'}

# The risk of health outcome per infection can be difficult to obtain from the literature. However, we can aggregate different burden estimates into
# a spreadsheet and convert them. For example, take the outcomes_incidence.csv included with the package. This has different
# types of incidence estimates:

outcomes_incidence <- read.csv(file = system.file(package = "rsvie", "extdata", "econ", "outcomes_incidence.csv"))

# `outcomes_incidence` includes the incidence of each outcome per age group. This can be done by rates of incidence per 100,000 infected individuals
# (`inc_inf` in the metric column), or rates of incidence per 100,000 individuals (inc in the metric column), or the absolute number of cases per year ('n' in the metric column).
# The user can copy this Excel spreadsheet and change the incidences according to their beliefs.

# To estimate the risk per infection of each outcome, we need to load the model-predicted number of cases and 
# covert `inc` and `n` to `inc_inf`:

# This loads the model-predicted incidence in each age group 
model_cases_sample_mean_get <- load(file = system.file(package = "rsvie", "extdata", "model_cases_sample_mean.RData"))
model_cases_sample_mean <- get(model_cases_sample_mean_get)

# This function then converts `outcomes_incidence` to the risk per infection of each outcome
risks_raw <- covert_raw_to_risk(RSVempty, outcomes_incidence, model_cases_sample_mean)

# For Palivizumab risks, we have a preloaded package from literature 
risks_vhr_raw <- read.csv(file = system.file(package = "rsvie", "extdata", "econ", "outcome_risks_vhr.csv"))

```

## 3. Add in the economics (cost and QALYs) per outcome

Now, we need to load the QALY loss and cost for each outcome per age group. 

```{r risks, echo=FALSE, results='hide'}

# Similar to before, we load an Excel spreadsheet with all this information
econ_raw <- read.csv(file = system.file(package = "rsvie", "extdata", "econ", "econ_pars.csv")) 

# For QALY, we have the QALY loss per outcome per age group with the mean and confidence intervals if available
# For cost, we have the cost per outcome per age group with mean and confidence intervals if available. 
# The user can copy this Excel spreadsheet and change the QALY loss and costs according to their beliefs.


# Finally we can call: 

RSVempty <- add_economics(RSVempty, econ_name = "E_W2023", econ_raw, risks_raw, risks_vhr_raw)

# We can check the slots to make sure these have been added properly
RSVempty@risks_df 
RSVempty@econ_df 
RSVempty@outcomes_vec  # vector of outcomes considered

# Note: To help with sampling times, the model fits a triangular distribution to each risk and economic outcome and samples 1000 values. 
# These values can be seen here
RSVempty@samples_outcomes 

# You can also make some plots by calling:
plot_economics(RSVempty)
plot_economics_fit(RSVempty)

```


## 5. Add intervention programmes

With the economics and risks defined, we can now define an intervention programme. We have several vignettes showing how to evaluate various types of programmes that use different products. Here is a simple example:

```{r calendars, echo=FALSE, results='hide'}

# To evaluate a seasonal monoclonal given at birth, we load an Excel spreadsheet such as:
cal_vhr_s <- read.csv(file = system.file(package = "rsvie", "extdata", "calendars", "cal_vhr_s.csv")) 
cal_lav_oa_65 <- read.csv(file = system.file(package = "rsvie", "extdata", "calendars", "cal_lav_oa_65.csv")) 

# In this spreadsheet you can define the start and end date for each age group and the coverage. Note the year doesn't matter, but if you
# wish to evaluate over a seasonal from Dec -> Jan, the year must increase by 1
# The uptake is defined as linear, which means through the administration window, it is given uniformly. This is appropriate for a product given at birth
# other options are available for different programmes, e.g. older adults, where uptake is higher at the start of the season. See `*_lav` vignette. 

```

## 6. Define the immunological profile of the product used

```{r load immunology, echo=FALSE, results='hide'}

oa_papi_nobound_wane_get <- load(file = system.file(package = "rsvie", "extdata", "efficacies", "oa_papi_nobound_post_wane.RData")) 
oa_papi_nobound_wane <- get(oa_papi_nobound_wane_get)
disease_eff <- read_rds( here::here("inst", "extdata", "efficacies", "disease_specific.rda"))

```

We must also define the immunological profile of the product we are evaluating. To do this, we define a list with two entries
* `mass`,  defines the immunological profile for the mass administration product
* `vhr`, defines the immunological profile for the palivizumab programme
* `disease_eff`, if efficacy changes for different outcomes, the values can be given here, and the outputs will be adjusted accordingly.
  
For `mass` and `vhr`, we define a list with the following options:

* `product`, name of the product evaluated. This can be `mat` for maternal programme, `mab` for long-acting monoclonal antibodies, or `lav` for live active vaccine (older adults)
* `wane function`, defined as "a * exp(b * t)", currently, this doesn't do anything, but in future iterations, this will allow the user to define different options. The default assumption on waning is Erlang-3.
* `a` is the proportion of vaccinated infants that move to the protected group
* `b` is the rate at which people lose immunity between each of the three vaccinated compartments 
* `sero_delay` the delay between vaccination and acquiring immunity (instant for mabs)

An example of mabs is given below:

```{r define immunology, echo=FALSE, results='hide'}

immune_profile_lav <- list(
    mass = list(
        product = "lav",
        wane_function = "a * exp(b * t))",  a = oa_papi_nobound_wane$wane_a_er3, b =  1/oa_papi_nobound_wane$wane_b_er3,
        sero_delay = "none"
    ),
    vhr = list(
        product = "pal",
        wane_function = "a * exp(b * t))", a = 0.7, b = 1 / 60,
        sero_delay = "none"
    ),
    disease_eff = disease_eff,
    direct = FALSE
)


```

How do we know `a` and `b` in the immunological definitions? We used a Bayesian model fit defined in the package ``, with more details in the SI of the paper.
We emphasise that the immune waning follows a Erlang-3 distribution. In future developments of this package we will add other options. For now, we recommend using the default options for immune waning defined in the package.

We can then add the immunological profile and intervention programme to the class, which has its economics defined, by the function:

```{r add programme, echo=FALSE, results='hide'}

RSV_mab_s <- add_programme(RSVempty, prog_name = "mab_s", cal_lav_oa_65, cal_vhr_s, immune_profile_lav)

```


## 7. Simulate the intervention programme

To simulate a programme, we call `rsvie::run` on the class defined above. This will simulate the programme and return a class with the results.

```{r run, echo=FALSE, results='hide'}

RSV_mab_s <- rsvie::run(RSV_mab_s)

```

## 8. Extract incidence for further exploration 

```{r post-process, echo=FALSE, results='hide'}

checkout_incidence(RSV_mab_s)

```